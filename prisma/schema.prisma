// Supply Chain Scenario Simulator - Prisma Schema
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// MULTI-TENANT FOUNDATION
// ==========================================

model Organisatie {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String?

  // Settings
  timezone String @default("UTC")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users           User[]
  scenarios       Scenario[]
  variables       Variable[]
  parameters      Parameter[]
  effectCurves    EffectCurve[]
  auditLogs       AuditLog[]
  skuEffectCurves SkuEffectCurve[]

  @@index([slug])
  @@map("organizations") // Keep table name for backward compatibility
}

model User {
  id    String   @id @default(cuid())
  email String   @unique
  name  String?
  role  UserRole @default(VIEWER)

  // Multi-tenant link
  organizationId String
  organisatie    Organisatie @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // NextAuth fields
  emailVerified DateTime?
  image         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  accounts  Account[]
  sessions  Session[]
  auditLogs AuditLog[]

  @@index([organizationId])
  @@index([email])
}

enum UserRole {
  ADMIN // Full access: manage org, users, all scenarios
  EDITOR // Edit scenarios, variables, parameters
  VIEWER // Read-only access to scenarios and reports
}

// ==========================================
// NEXTAUTH MODELS
// ==========================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ==========================================
// SCENARIOS - WHAT-IF ANALYSES
// ==========================================

model Scenario {
  id          String  @id @default(cuid())
  name        String
  description String?

  // Multi-tenant link
  organizationId String
  organisatie    Organisatie @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Scenario configuration
  isBaseline     Boolean        @default(false) // Only one baseline per organization
  timePeriodType TimePeriodType @default(SINGLE_POINT)
  startDate      DateTime? // For time-series scenarios
  endDate        DateTime?

  // Cloning support (track lineage)
  parentId String?
  parent   Scenario?  @relation("ScenarioClones", fields: [parentId], references: [id], onDelete: SetNull)
  clones   Scenario[] @relation("ScenarioClones")

  // Metadata
  tags String[] // For categorization/filtering

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  variableValues VariableValue[]
  calculations   Calculation[]

  @@index([organizationId])
  @@index([parentId])
  @@index([isBaseline])
}

enum TimePeriodType {
  SINGLE_POINT // One-time calculation (no time dimension)
  MONTHLY // Monthly time series
  QUARTERLY // Quarterly projections
  YEARLY // Annual forecasts
}

// ==========================================
// VARIABLES - INPUTS AND OUTPUTS
// ==========================================

model Variable {
  id String @id @default(cuid())

  // Multi-tenant link
  organizationId String
  organisatie    Organisatie @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Variable identity
  name        String // Machine name: "INPUT_SALES_DEMAND"
  displayName String // Human name: "Sales Demand"
  description String?
  unit        String? // "pallets", "days", "%", "EUR"

  // Variable type
  variableType VariableType
  dataType     DataType     @default(NUMERIC)

  // Effect curve (optional non-linear transformation)
  effectCurveId String?
  effectCurve   EffectCurve? @relation(fields: [effectCurveId], references: [id], onDelete: SetNull)

  // Formula (for OUTPUT variables only)
  formula      String?  @db.Text // "INPUT_SALES * PARAM_LEAD_TIME / INPUT_ORDER_QTY"
  dependencies String[] // Array of variable names this depends on (for topological sort)

  // UI organization
  category     String? // "Demand", "Inventory", "Capacity", "Financial"
  displayOrder Int     @default(0)

  // Validation metadata
  validationRules Json? // { "min": 0, "max": 1000, "required": true }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  values VariableValue[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([variableType])
  @@index([category])
}

enum VariableType {
  INPUT // User-defined values (manually entered)
  OUTPUT // Calculated from formula
}

enum DataType {
  NUMERIC // Decimal numbers (float)
  PERCENTAGE // 0-100% (stored as float)
  BOOLEAN // True/false (stored as 1/0)
  TEXT // String values (rare, for metadata)
}

// ==========================================
// EFFECT CURVES - NON-LINEAR TRANSFORMATIONS
// ==========================================

model EffectCurve {
  id          String    @id @default(cuid())
  name        String
  description String?
  curveType   CurveType

  // Multi-tenant link
  organizationId String
  organisatie    Organisatie @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Curve configuration (JSON for flexibility)
  parameters Json @db.JsonB
  // Examples by curve type:
  // LINEAR:      { "slope": 1, "intercept": 0 }
  // LOGARITHMIC: { "base": 10, "multiplier": 1, "offset": 0 }
  // EXPONENTIAL: { "base": 2, "exponent": 1.5, "multiplier": 1 }
  // STEP_WISE:   { "thresholds": [100, 500, 1000], "values": [1.0, 0.85, 0.75, 0.65] }
  // CUSTOM:      { "points": [{"x": 0, "y": 0}, {"x": 50, "y": 1}], "interpolationMethod": "linear" }

  // Preview generation metadata
  previewRange Json? @db.JsonB // { "min": 0, "max": 1000, "step": 10 }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  variables Variable[]

  @@index([organizationId])
  @@index([curveType])
}

enum CurveType {
  LINEAR // y = mx + b
  LOGARITHMIC // y = m * log_b(x) - diminishing returns
  EXPONENTIAL // y = b^(x*e) - compounding effects
  STEP_WISE // Discrete steps at thresholds (capacity tiers)
  CUSTOM_INTERPOLATED // User-defined points with linear interpolation
}

// ==========================================
// PARAMETERS - GLOBAL CONFIGURATION
// ==========================================

model Parameter {
  id String @id @default(cuid())

  // Multi-tenant link
  organizationId String
  organisatie    Organisatie @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Parameter identity
  name        String // Machine name: "PARAM_LEAD_TIME"
  displayName String // Human name: "Lead Time (days)"
  description String?
  value       Float // Single global value per org
  unit        String? // "days", "hours", "%"

  // UI organization
  category     String? // Group related parameters
  displayOrder Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([category])
}

// ==========================================
// VARIABLE VALUES - SCENARIO-SPECIFIC DATA
// ==========================================

model VariableValue {
  id String @id @default(cuid())

  // Links
  scenarioId String
  scenario   Scenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  variableId String
  variable   Variable @relation(fields: [variableId], references: [id], onDelete: Cascade)

  // Time series support
  periodStart DateTime? // For MONTHLY/QUARTERLY/YEARLY scenarios
  periodEnd   DateTime?

  // The value
  value Float

  // Metadata
  isManual Boolean @default(true) // false if auto-calculated
  notes    String? // User annotations

  // Audit trail
  lastModifiedBy String? // User ID who last modified
  modifiedAt     DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Unique constraint: one value per scenario + variable + period
  @@unique([scenarioId, variableId, periodStart])
  @@index([scenarioId])
  @@index([variableId])
  @@index([scenarioId, variableId])
  @@index([periodStart])
}

// ==========================================
// CALCULATIONS - CACHED RESULTS
// ==========================================

model Calculation {
  id String @id @default(cuid())

  // Link to scenario
  scenarioId String
  scenario   Scenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)

  // Time series support
  periodStart DateTime?
  periodEnd   DateTime?

  // Results (JSON for flexibility)
  results Json @db.JsonB
  // Structure:
  // {
  //   "var_id_1": {
  //     "value": 320,
  //     "rawValue": 336,
  //     "delta": -130,
  //     "percentChange": -28.89,
  //     "bottlenecks": [],
  //     "effectCurveApplied": true,
  //     "calculatedAt": "2024-01-15T10:30:00Z",
  //     "dependencies": ["INPUT_SALES", "PARAM_LEAD_TIME"]
  //   }
  // }

  // Comparison metadata
  baselineScenarioId String? // Which scenario we're comparing to

  // Performance tracking
  calculationTime DateTime @default(now())
  executionTimeMs Int? // Track calculation performance

  // Versioning
  version Int @default(1) // Increment on recalculation

  // Error tracking
  hasErrors Boolean @default(false)
  errorLog  Json?   @db.JsonB // Array of error objects

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Unique: one calculation per scenario + period + version
  @@unique([scenarioId, periodStart, version])
  @@index([scenarioId])
  @@index([scenarioId, version])
  @@index([baselineScenarioId])
  @@index([calculationTime])
  @@index([hasErrors])
}

// ==========================================
// AUDIT LOG - CHANGE TRACKING
// ==========================================

model AuditLog {
  id String @id @default(cuid())

  // Who did it
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Multi-tenant link
  organizationId String
  organisatie    Organisatie @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // What was changed
  entityType String // "Scenario", "Variable", "VariableValue", "Parameter"
  entityId   String // ID of the entity
  action     String // "CREATE", "UPDATE", "DELETE"

  // Change details (JSON for flexibility)
  changesBefore Json? @db.JsonB // Old values (null for CREATE)
  changesAfter  Json? @db.JsonB // New values (null for DELETE)

  // Metadata
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

// ==========================================
// SKU EFFECT CURVE - NON-LINEAR SKU IMPACT
// ==========================================

model SkuEffectCurve {
  id String @id @default(cuid())

  // Multi-tenant link
  organizationId String
  organisatie    Organisatie @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // SKU range (in steps of 50)
  skuRangeStart Int // e.g., 6500, 6550, 6600

  // Effect multiplier (1.0 = linear, 0.99 = slight diminishing returns)
  effectMultiplier Float @default(1.0)

  // Optional: Description for this range
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Unique: one entry per org + SKU range
  @@unique([organizationId, skuRangeStart])
  @@index([organizationId])
  @@index([skuRangeStart])
  @@map("sku_effect_curves")
}
